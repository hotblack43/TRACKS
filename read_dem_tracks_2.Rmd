---
title: "Tracks_latitude_vs_NAO.Rmd"
author: "Peter Thejll"
date: "01/04/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd('~/WORKSHOP/TRACKS/')
```

## Find the matching files
```{r}
str <- 'cfsr'
str <- 'erai'
names <- paste0('*',str,'_track.dat')
files <- list.files("OUTPUT/",pattern=names)
```

Use bootstrapping (with replacement) to test robustness of the storm-track latitude vs NAO relationship. Go back to original ERAI and CFSR storm tracks and re-calculate median latitudes for track segments inside an 'North-Eastern Atlantic - North Sea' box.

Note that data on storm tracks are available for 2001 only.

## Fetch the monthly NAO index so it can be interpolated in later

```{r}
# Use either the NOAA CDC PC-based NAO index 
# or the Hurrell index

#NAO <- read.table("DATA/JD_NAO.dat")
NAO <- read.table("DATA/JD_NAO_Hurrell.dat")
colnames(NAO) <- c("NAO_JD","NAO_NAO")
```

## Do a bootstrap with replacement on the filenames

```{r}
nMC <- 1000  # Number of Bootstraps to perform
samp <-NULL
allresults <- NULL
for(i in 1:nMC){
  results <- NULL
  samp <-sample(files, size = length(files), replace = T)
  # Read the data from each file in the sample
  for (j in 1:length(samp)){
    
    data <- as.data.frame(read.csv(paste0("OUTPUT/",samp[j]),header=F,sep=""))
    data <- data[,-1]
    colnames(data) <- c("JD","longitude","latitude","pressure")
    # interpolate in te NAO table so that a column can be added to the df ...
    NAO_interpolated <- approx(NAO$NAO_JD,NAO$NAO_NAO,data$JD)
    data <- cbind(data,NAO_interpolated$y)
    colnames(data) <- c("JD","longitude","latitude","pressure","NAO")
    # wrap around at longitude 359.9999 degress
    idx <- which(data$longitude < 180)
    if (length(idx) != 0L) {data$longitude[idx] <- data$longitude[idx]+360.0}
    # Do the analysis for this member of the bootstrap sample
    # select the track points on basis of lon and lat in a box
    idx <- which(data$longitude > 350 & data$longitude < 360+10 & data$latitude > 25)
    if (length(idx) > 3) {
      #      print(paste(mean(data$NAO[idx]),mean(data$latitude[idx])))
      results <- rbind(results,c(mean(data$NAO[idx]),mean(data$latitude[idx])))
    }
    #print(paste(i,j,length(idx)))
  } # end j loop
  # for this sample the table is built, now get NAO quantiles and then the medians of the latitudes over and under them
  q <- quantile(results[,1])
  q25 <- q[2]
  idx <- which (results[,1] < q25)
  q75 <- q[4]
  jdx <- which (results[,1] > q75)
  # print the median of the latitudes below and above those quantiles
  lat_below_q25NAO <- median(results[idx,2])
  lat_above_q75NAO <- median(results[jdx,2])
    #print(paste(lat_below_q25NAO,lat_above_q75NAO))
  allresults <- rbind(allresults,c(lat_below_q25NAO,lat_above_q75NAO))
} # end i loop
```

## read each file and aggregate results
```{r}
#plot(allresults[,1],allresults[,2],pch=20,xlab="Median lat for q25",ylab="Median lat for q75")
hist(allresults[,1], col='blue',xlim=c(10,90),xlab="Median latitude",main=paste(str,"Effect of NAO on storm latitude"))
hist(allresults[,2], col=2, add=T,xlim=c(10,90))
hist(allresults[,1], col='blue', add=T,xlim=c(10,90))
hist(allresults[,2], col=rgb(1,0,0,0.5), add=T,xlim=c(10,90))
sprintf("Median latitude for low  NAO: %f",median(allresults[,1]))
sprintf("Median latitude for high NAO: %f",median(allresults[,2]))
```



